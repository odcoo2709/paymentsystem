<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Order & Wallet Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Apple SD Gothic Neo', -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .admin-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .admin-title {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button:hover {
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #3498db;
            background: white;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 14px;
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        .orders-section, .wallets-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select, .search-box {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .search-box {
            width: 250px;
        }

        .refresh-button, .add-button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .add-button {
            background: #27ae60;
        }

        .refresh-button:hover {
            background: #2980b9;
        }

        .add-button:hover {
            background: #219653;
        }

        .export-button {
            padding: 10px 20px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .export-button:hover {
            background: #8e44ad;
        }

        .orders-table-container, .wallets-table-container {
            overflow-x: auto;
        }

        .orders-table, .wallets-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .wallets-table {
            min-width: 800px;
        }

        .orders-table th, .wallets-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }

        .orders-table td, .wallets-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .orders-table tr:hover, .wallets-table tr:hover {
            background: #f8f9fa;
        }

        .order-id, .wallet-id {
            font-weight: bold;
            color: #2c3e50;
            font-family: monospace;
        }

        .order-time {
            font-size: 12px;
            color: #7f8c8d;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-align: center;
            min-width: 80px;
        }

        .status-waiting { background: #f39c12; }
        .status-confirmed { background: #3498db; }
        .status-processing { background: #9b59b6; }
        .status-completed { background: #27ae60; }
        .status-cancelled { background: #e74c3c; }

        .wallet-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-align: center;
            min-width: 80px;
        }

        .wallet-active { background: #27ae60; }
        .wallet-inactive { background: #95a5a6; }

        .network-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-right: 5px;
        }

        .network-trc20 { background: #e74c3c; }
        .network-erc20 { background: #3498db; }
        .network-bep20 { background: #2ecc71; }
        .network-solana { background: #9b59b6; }
        .network-polygon { background: #8e44ad; }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .action-view { background: #3498db; color: white; }
        .action-confirm { background: #2ecc71; color: white; }
        .action-process { background: #9b59b6; color: white; }
        .action-complete { background: #27ae60; color: white; }
        .action-cancel { background: #e74c3c; color: white; }
        .action-reset { background: #f39c12; color: white; }
        .action-edit { background: #3498db; color: white; }
        .action-delete { background: #e74c3c; color: white; }
        .action-activate { background: #2ecc71; color: white; }
        .action-deactivate { background: #95a5a6; color: white; }
        .action-setdefault { background: #f39c12; color: white; }

        .no-orders, .no-wallets {
            text-align: center;
            padding: 50px;
            color: #95a5a6;
            font-size: 16px;
        }

        .amount-display {
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-indicator {
            width: 100px;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            background: #3498db;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 12px;
            color: #2c3e50;
            word-break: break-all;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-top: 5px;
            border: 1px solid #e9ecef;
        }

        .qr-code-small {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dee2e6;
            margin: 0 auto;
        }

        .qr-code-small img {
            max-width: 100%;
            max-height: 100%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #95a5a6;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-button.primary {
            background: #3498db;
            color: white;
        }

        .modal-button.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .modal-button.success {
            background: #27ae60;
            color: white;
        }

        .modal-button.danger {
            background: #e74c3c;
            color: white;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .hidden {
            display: none;
        }

        .time-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .active-wallet-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .default-wallet-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #f39c12;
            color: white;
            font-size: 10px;
            border-radius: 10px;
            margin-left: 5px;
        }

        .wallet-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .total-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
        }

        .save-status.show {
            display: block;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .filter-controls {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .search-box {
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Ìó§Îçî -->
        <div class="admin-header">
            <h1 class="admin-title">üìä Order & Wallet Management System</h1>
            <p class="admin-subtitle">Manage user orders and wallet settings in one place</p>
        </div>

        <!-- ÌÉ≠ Î©îÎâ¥ -->
        <div class="tabs">
            <button class="tab-button active" data-tab="orders">üìã Order Management</button>
            <button class="tab-button" data-tab="wallets">üëõ Wallet Management</button>
        </div>

        <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-change">All orders</div>
            </div>
            <div class="stat-card">
                <h3>Waiting Deposit</h3>
                <div class="stat-value" id="waitingOrders">0</div>
                <div class="stat-change" id="waitingChange">0 waiting</div>
            </div>
            <div class="stat-card">
                <h3>Active Wallets</h3>
                <div class="stat-value" id="activeWallets">0</div>
                <div class="stat-change" id="walletsChange">available</div>
            </div>
            <div class="stat-card">
                <h3>Today's Revenue</h3>
                <div class="stat-value" id="todayRevenue">0 THB</div>
                <div class="stat-change">Total transaction</div>
            </div>
        </div>

        <!-- Ï£ºÎ¨∏ Í¥ÄÎ¶¨ ÌÉ≠ -->
        <div id="ordersTab" class="tab-content active">
            <div class="orders-section">
                <div class="section-header">
                    <h2 class="section-title">üìã Order List</h2>
                    <div class="filter-controls">
                        <input type="text" class="search-box" id="searchOrder" placeholder="Search order ID...">
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="ÏûÖÍ∏àÎåÄÍ∏∞">Waiting Deposit</option>
                            <option value="ÏûÖÍ∏àÌôïÏù∏">Deposit Confirmed</option>
                            <option value="Ï≤òÎ¶¨Ï§ë">Processing</option>
                            <option value="ÏôÑÎ£å">Completed</option>
                            <option value="Ï∑®ÏÜå">Cancelled</option>
                        </select>
                        <div class="time-filter">
                            <input type="date" class="time-input" id="dateFrom">
                            <span>~</span>
                            <input type="date" class="time-input" id="dateTo">
                        </div>
                        <button class="export-button" id="exportOrders">üì• Export Orders</button>
                        <button class="refresh-button" id="refreshOrders">üîÑ Refresh</button>
                    </div>
                </div>

                <div class="orders-table-container">
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Time</th>
                                <th>Amount (THB)</th>
                                <th>Wallet</th>
                                <th>Status</th>
                                <th>Step</th>
                                <th>Proof</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" class="no-orders">No orders</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÏßÄÍ∞ë Í¥ÄÎ¶¨ ÌÉ≠ -->
        <div id="walletsTab" class="tab-content">
            <div class="wallets-section">
                <div class="section-header">
                    <h2 class="section-title">üëõ Wallet List</h2>
                    <div class="filter-controls">
                        <select class="filter-select" id="walletStatusFilter">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <select class="filter-select" id="walletNetworkFilter">
                            <option value="all">All Networks</option>
                            <option value="TRC20">TRC20</option>
                            <option value="ERC20">ERC20</option>
                            <option value="BEP20">BEP20</option>
                            <option value="Solana">Solana</option>
                            <option value="Polygon">Polygon</option>
                        </select>
                        <button class="add-button" id="addWallet">‚ûï Add New Wallet</button>
                        <button class="refresh-button" id="refreshWallets">üîÑ Refresh</button>
                    </div>
                </div>

                <div class="wallets-table-container">
                    <table class="wallets-table" id="walletsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Network</th>
                                <th>Address</th>
                                <th>QR Code</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="walletsTableBody">
                            <tr>
                                <td colspan="7" class="no-wallets">No wallets. Please add a new wallet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üí° Wallet Management Guide</h3>
                    <ul style="color: #4a5568; line-height: 1.6; padding-left: 20px;">
                        <li>You can add, edit, and delete multiple wallets.</li>
                        <li><strong>Active wallets</strong> are displayed on the user page.</li>
                        <li><strong>Default wallet</strong> cannot be deleted, but its active status can be changed.</li>
                        <li>You can upload QR code images for each wallet.</li>
                        <li>Manage wallets by network type.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Ï†ÄÏû• ÏÉÅÌÉú ÌëúÏãú -->
    <div class="save-status" id="saveStatus">
        File saved successfully!
    </div>

    <!-- Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div class="modal-overlay hidden" id="orderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìã Order Details</h3>
                <button class="modal-close" id="closeDetailModal">‚úï</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- ÎèôÏ†Å ÎÇ¥Ïö© -->
            </div>
            <div class="modal-actions" id="orderDetailActions">
                <!-- ÎèôÏ†Å Ïï°ÏÖò Î≤ÑÌäº -->
            </div>
        </div>
    </div>

    <!-- ÏßÄÍ∞ë Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
    <div class="modal-overlay hidden" id="walletModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="walletModalTitle">üëõ Add New Wallet</h3>
                <button class="modal-close" id="closeWalletModal">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="walletForm">
                    <div class="form-group">
                        <label class="form-label">Wallet Name *</label>
                        <input type="text" class="form-input" id="walletName" 
                               placeholder="ex: Main TRC20 Wallet" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Network *</label>
                            <select class="form-select" id="walletNetwork" required>
                                <option value="">Select</option>
                                <option value="TRC20">TRC20 (Tron)</option>
                                <option value="ERC20">ERC20 (Ethereum)</option>
                                <option value="BEP20">BEP20 (BNB Smart Chain)</option>
                                <option value="Solana">Solana</option>
                                <option value="Polygon">Polygon</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="walletStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Wallet Address *</label>
                        <textarea class="form-textarea" id="walletAddress" 
                                  placeholder="Enter wallet address" 
                                  rows="3" required></textarea>
                        <small style="color: #718096; font-size: 12px;">
                            * Enter correct wallet address. Format varies by network.
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">QR Code Image (Optional)</label>
                        <input type="file" class="form-input" id="walletQRCode" 
                               accept="image/*">
                        <small style="color: #718096; font-size: 12px;">
                            * Upload QR code image for wallet address. (Recommended size: 200x200px)
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Memo (Optional)</label>
                        <textarea class="form-textarea" id="walletMemo" 
                                  placeholder="Additional information about the wallet" 
                                  rows="2"></textarea>
                    </div>

                    <input type="hidden" id="walletId">
                </form>
            </div>
            <div class="modal-actions">
                <button class="modal-button secondary" id="cancelWalletModal">Cancel</button>
                <button class="modal-button primary" id="saveWallet">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ÏÉÅÌÉú Í¥ÄÎ¶¨
        let allOrders = [];
        let allWallets = [];
        let currentFilter = 'all';
        let selectedOrder = null;
        let selectedWallet = null;
        let currentTab = 'orders';
        let qrCodeFile = null;

        // DOM ÏöîÏÜå
        const elements = {
            // ÌÜµÍ≥Ñ
            totalOrders: document.getElementById('totalOrders'),
            waitingOrders: document.getElementById('waitingOrders'),
            activeWallets: document.getElementById('activeWallets'),
            todayRevenue: document.getElementById('todayRevenue'),
            waitingChange: document.getElementById('waitingChange'),
            walletsChange: document.getElementById('walletsChange'),
            
            // ÌÉ≠
            tabButtons: document.querySelectorAll('.tab-button'),
            ordersTab: document.getElementById('ordersTab'),
            walletsTab: document.getElementById('walletsTab'),
            
            // Ï£ºÎ¨∏ Í¥ÄÎ¶¨
            ordersTableBody: document.getElementById('ordersTableBody'),
            statusFilter: document.getElementById('statusFilter'),
            searchOrder: document.getElementById('searchOrder'),
            dateFrom: document.getElementById('dateFrom'),
            dateTo: document.getElementById('dateTo'),
            exportOrders: document.getElementById('exportOrders'),
            refreshOrders: document.getElementById('refreshOrders'),
            
            // ÏßÄÍ∞ë Í¥ÄÎ¶¨
            walletsTableBody: document.getElementById('walletsTableBody'),
            walletStatusFilter: document.getElementById('walletStatusFilter'),
            walletNetworkFilter: document.getElementById('walletNetworkFilter'),
            addWallet: document.getElementById('addWallet'),
            refreshWallets: document.getElementById('refreshWallets'),
            
            // Î™®Îã¨
            orderDetailModal: document.getElementById('orderDetailModal'),
            closeDetailModal: document.getElementById('closeDetailModal'),
            orderDetailContent: document.getElementById('orderDetailContent'),
            orderDetailActions: document.getElementById('orderDetailActions'),
            
            walletModal: document.getElementById('walletModal'),
            closeWalletModal: document.getElementById('closeWalletModal'),
            cancelWalletModal: document.getElementById('cancelWalletModal'),
            walletModalTitle: document.getElementById('walletModalTitle'),
            walletForm: document.getElementById('walletForm'),
            walletName: document.getElementById('walletName'),
            walletNetwork: document.getElementById('walletNetwork'),
            walletStatus: document.getElementById('walletStatus'),
            walletAddress: document.getElementById('walletAddress'),
            walletQRCode: document.getElementById('walletQRCode'),
            walletMemo: document.getElementById('walletMemo'),
            walletId: document.getElementById('walletId'),
            saveWallet: document.getElementById('saveWallet'),
            
            // Ï†ÄÏû• ÏÉÅÌÉú
            saveStatus: document.getElementById('saveStatus')
        };

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // Ïò§Îäò ÎÇ†Ïßú ÏÑ§Ï†ï
            const today = new Date().toISOString().split('T')[0];
            elements.dateFrom.value = today;
            elements.dateTo.value = today;
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupEventListeners();
            
            // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadAllData();
            
            // 10Ï¥àÎßàÎã§ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
            setInterval(loadAllData, 10000);
        });

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            // ÌÉ≠ Ï†ÑÌôò
            elements.tabButtons.forEach(button => {
                button.addEventListener('click', switchTab);
            });
            
            // Ï£ºÎ¨∏ Í¥ÄÎ¶¨ ÌïÑÌÑ∞
            elements.statusFilter.addEventListener('change', updateOrders);
            elements.searchOrder.addEventListener('input', updateOrders);
            elements.dateFrom.addEventListener('change', updateOrders);
            elements.dateTo.addEventListener('change', updateOrders);
            elements.refreshOrders.addEventListener('click', () => loadAllData());
            elements.exportOrders.addEventListener('click', exportOrdersToExcel);
            
            // ÏßÄÍ∞ë Í¥ÄÎ¶¨ ÌïÑÌÑ∞
            elements.walletStatusFilter.addEventListener('change', updateWallets);
            elements.walletNetworkFilter.addEventListener('change', updateWallets);
            elements.refreshWallets.addEventListener('click', () => loadAllData());
            elements.addWallet.addEventListener('click', openAddWalletModal);
            
            // Î™®Îã¨ Îã´Í∏∞
            elements.closeDetailModal.addEventListener('click', closeOrderDetail);
            elements.closeWalletModal.addEventListener('click', closeWalletModal);
            elements.cancelWalletModal.addEventListener('click', closeWalletModal);
            
            // ÏßÄÍ∞ë Î™®Îã¨ Ï†ÄÏû• - FIXED: Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            elements.saveWallet.addEventListener('click', saveWallet);
            elements.walletQRCode.addEventListener('change', handleQRCodeUpload);
            
            // ÏßÄÍ∞ë Ìèº Ï†úÏ∂ú Î∞©ÏßÄ
            elements.walletForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveWallet();
            });
        }

        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(e) {
            const tabId = e.target.dataset.tab;
            currentTab = tabId;
            
            // ÌÉ≠ Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
            elements.tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            e.target.classList.add('active');
            
            // ÌÉ≠ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            elements.ordersTab.classList.remove('active');
            elements.walletsTab.classList.remove('active');
            
            if (tabId === 'orders') {
                elements.ordersTab.classList.add('active');
            } else if (tabId === 'wallets') {
                elements.walletsTab.classList.add('active');
            }
        }

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadAllData() {
            try {
                // Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                allOrders = JSON.parse(localStorage.getItem('payment_orders') || '[]');
                
                // ÏßÄÍ∞ë Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const walletsData = localStorage.getItem('payment_wallets');
                allWallets = walletsData ? JSON.parse(walletsData) : [];
                
                // Í∏∞Î≥∏ ÏßÄÍ∞ëÏù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                if (allWallets.length === 0) {
                    allWallets = [
                        {
                            id: 'wallet_1',
                            name: 'Default Wallet (TRC20)',
                            address: 'TXYZ1234567890abcdefghijklmnopqrstuvw',
                            network: 'TRC20',
                            qrCode: null,
                            isActive: true,
                            isDefault: true,
                            memo: 'Default wallet',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('payment_wallets', JSON.stringify(allWallets));
                }
                
                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateStats();
                
                // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
                updateOrders();
                updateWallets();
                
                // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
                notifyUserPageWalletsUpdate();
                
                console.log(`Data loaded: ${allOrders.length} orders, ${allWallets.length} wallets`);
            } catch (error) {
                console.error('Data load failed:', error);
            }
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const totalOrders = allOrders.length;
            const waitingOrders = allOrders.filter(o => o.status === 'ÏûÖÍ∏àÎåÄÍ∏∞').length;
            const activeWallets = allWallets.filter(w => w.isActive).length;
            
            // Ïò§Îäò Îß§Ï∂ú Í≥ÑÏÇ∞
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = allOrders.filter(o => {
                const orderDate = o.time.split('T')[0];
                return orderDate === today && o.status === 'ÏôÑÎ£å';
            });
            
            const todayRevenue = todayOrders.reduce((sum, order) => sum + order.amount, 0);
            
            elements.totalOrders.textContent = totalOrders;
            elements.waitingOrders.textContent = waitingOrders;
            elements.activeWallets.textContent = activeWallets;
            elements.todayRevenue.textContent = todayRevenue.toLocaleString() + ' THB';
            
            elements.waitingChange.textContent = `${waitingOrders} waiting`;
            elements.walletsChange.textContent = `${activeWallets} available`;
            
            if (waitingOrders > 0) {
                elements.waitingChange.classList.remove('negative');
            } else {
                elements.waitingChange.classList.add('negative');
            }
        }

        // Ï£ºÎ¨∏ ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ (ÏòÅÎ¨∏ÏúºÎ°ú Î≤àÏó≠)
        function updateOrders() {
            currentFilter = elements.statusFilter.value;
            const searchTerm = elements.searchOrder.value.toLowerCase();
            const dateFrom = elements.dateFrom.value;
            const dateTo = elements.dateTo.value;
            
            let filteredOrders = [...allOrders];
            
            // ÏÉÅÌÉú ÌïÑÌÑ∞ÎßÅ
            if (currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(o => o.status === currentFilter);
            }
            
            // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞ÎßÅ
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(o => 
                    o.id.toLowerCase().includes(searchTerm)
                );
            }
            
            // ÎÇ†Ïßú ÌïÑÌÑ∞ÎßÅ
            if (dateFrom && dateTo) {
                filteredOrders = filteredOrders.filter(o => {
                    const orderDate = o.time.split('T')[0];
                    return orderDate >= dateFrom && orderDate <= dateTo;
                });
            }
            
            // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredOrders.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            if (filteredOrders.length === 0) {
                elements.ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-orders">No search results</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredOrders.forEach(order => {
                const time = new Date(order.time).toLocaleString('ko-KR', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusClass = {
                    'ÏûÖÍ∏àÎåÄÍ∏∞': 'status-waiting',
                    'ÏûÖÍ∏àÌôïÏù∏': 'status-confirmed',
                    'Ï≤òÎ¶¨Ï§ë': 'status-processing',
                    'ÏôÑÎ£å': 'status-completed',
                    'Ï∑®ÏÜå': 'status-cancelled'
                }[order.status] || 'status-waiting';
                
                // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≤àÏó≠
                const statusText = {
                    'ÏûÖÍ∏àÎåÄÍ∏∞': 'Waiting Deposit',
                    'ÏûÖÍ∏àÌôïÏù∏': 'Deposit Confirmed',
                    'Ï≤òÎ¶¨Ï§ë': 'Processing',
                    'ÏôÑÎ£å': 'Completed',
                    'Ï∑®ÏÜå': 'Cancelled'
                }[order.status] || order.status;
                
                const stepProgress = Math.min(100, (order.step || 1) * 25);
                
                // Ï¶ùÎ™ÖÏÑú Ïó¨Î∂Ä ÌôïÏù∏
                const hasProof = order.proof && order.proof.data;
                const proofButton = hasProof ? 
                    `<button class="action-button action-view" onclick="viewProof('${order.id}')">View</button>` :
                    'None';
                
                // ÏßÄÍ∞ë Ï†ïÎ≥¥
                const walletInfo = order.wallet ? 
                    `${order.wallet.name} (${order.wallet.network})` : 'Not specified';
                
                // Îã®Í≥Ñ ÌÖçÏä§Ìä∏
                const stepText = getStepText(order.step || 1);
                
                html += `
                    <tr onclick="showOrderDetail('${order.id}')" style="cursor: pointer;">
                        <td>
                            <div class="order-id">${order.id}</div>
                            <div class="order-time">${time}</div>
                        </td>
                        <td>
                            <div class="amount-display">${order.amount.toLocaleString()} THB</div>
                        </td>
                        <td>
                            <div>${walletInfo}</div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <div>${stepText}</div>
                            <div class="progress-indicator">
                                <div class="progress-bar" style="width: ${stepProgress}%"></div>
                            </div>
                        </td>
                        <td>
                            ${proofButton}
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${order.status === 'ÏûÖÍ∏àÎåÄÍ∏∞' ? `
                                    <button class="action-button action-confirm" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'ÏûÖÍ∏àÌôïÏù∏')">Confirm Deposit</button>
                                    <button class="action-button action-cancel" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'Ï∑®ÏÜå')">Cancel</button>
                                ` : ''}
                                ${order.status === 'ÏûÖÍ∏àÌôïÏù∏' ? `
                                    <button class="action-button action-process" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'Ï≤òÎ¶¨Ï§ë')">Start Process</button>
                                    <button class="action-button action-cancel" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'Ï∑®ÏÜå')">Cancel Process</button>
                                ` : ''}
                                ${order.status === 'Ï≤òÎ¶¨Ï§ë' ? `
                                    <button class="action-button action-complete" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'ÏôÑÎ£å')">Complete</button>
                                ` : ''}
                                ${['ÏôÑÎ£å', 'Ï∑®ÏÜå'].includes(order.status) ? `
                                    <button class="action-button action-reset" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'ÏûÖÍ∏àÎåÄÍ∏∞')">Reset</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            elements.ordersTableBody.innerHTML = html;
        }

        // Îã®Í≥Ñ ÌÖçÏä§Ìä∏ Î≥ÄÌôò (ÏòÅÎ¨∏)
        function getStepText(step) {
            switch(step) {
                case 1: return 'Waiting USDT Transfer';
                case 2: return 'Verifying Deposit';
                case 3: return 'Processing THB';
                case 4: return 'Completed';
                default: return 'Waiting';
            }
        }

        // ÏßÄÍ∞ë ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateWallets() {
            const statusFilter = elements.walletStatusFilter.value;
            const networkFilter = elements.walletNetworkFilter.value;
            
            let filteredWallets = [...allWallets];
            
            // ÏÉÅÌÉú ÌïÑÌÑ∞ÎßÅ
            if (statusFilter !== 'all') {
                filteredWallets = filteredWallets.filter(w => 
                    statusFilter === 'active' ? w.isActive : !w.isActive
                );
            }
            
            // ÎÑ§Ìä∏ÏõåÌÅ¨ ÌïÑÌÑ∞ÎßÅ
            if (networkFilter !== 'all') {
                filteredWallets = filteredWallets.filter(w => w.network === networkFilter);
            }
            
            // ÏÉùÏÑ±Ïùº Í∏∞Ï§Ä Ï†ïÎ†¨
            filteredWallets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            if (filteredWallets.length === 0) {
                elements.walletsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-wallets">No wallets match the filter</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredWallets.forEach(wallet => {
                const networkClass = `network-${wallet.network.toLowerCase()}`;
                const createdDate = new Date(wallet.createdAt).toLocaleDateString('ko-KR');
                
                // ÏÉÅÌÉú ÌëúÏãú
                const statusText = wallet.isActive ? 'Active' : 'Inactive';
                const statusClass = wallet.isActive ? 'wallet-active' : 'wallet-inactive';
                
                // Í∏∞Î≥∏ ÏßÄÍ∞ë Î∞∞ÏßÄ
                const defaultBadge = wallet.isDefault ? '<span class="default-wallet-badge">Default</span>' : '';
                
                // QR ÏΩîÎìú ÌëúÏãú
                let qrDisplay = '';
                if (wallet.qrCode && wallet.qrCode !== 'null' && wallet.qrCode !== '') {
                    qrDisplay = `
                        <div class="qr-code-small">
                            <img src="${wallet.qrCode}" alt="QR Code">
                        </div>
                    `;
                } else {
                    qrDisplay = '<div style="text-align: center;">-</div>';
                }
                
                // Ï£ºÏÜå Îã®Ï∂ï
                const shortAddress = wallet.address.length > 20 ? 
                    wallet.address.substring(0, 10) + '...' + wallet.address.substring(wallet.address.length - 10) : 
                    wallet.address;
                
                html += `
                    <tr>
                        <td>
                            <div style="font-weight: bold; color: #2c3e50;">
                                ${wallet.name} ${defaultBadge}
                            </div>
                            ${wallet.memo ? `<div style="font-size: 12px; color: #718096; margin-top: 5px;">${wallet.memo}</div>` : ''}
                        </td>
                        <td>
                            <span class="network-badge ${networkClass}">${wallet.network}</span>
                        </td>
                        <td>
                            <div style="font-size: 12px; color: #2c3e50;">${shortAddress}</div>
                            <div class="wallet-address" title="${wallet.address}">
                                ${wallet.address}
                            </div>
                        </td>
                        <td>${qrDisplay}</td>
                        <td>
                            <span class="wallet-status ${statusClass}">
                                ${wallet.isActive ? '<span class="active-wallet-indicator"></span>' : ''}
                                ${statusText}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="wallet-actions">
                                <button class="action-button action-edit" onclick="editWallet('${wallet.id}')">Edit</button>
                                ${!wallet.isDefault ? `
                                    <button class="action-button action-delete" onclick="deleteWallet('${wallet.id}')">Delete</button>
                                ` : ''}
                                ${wallet.isActive ? 
                                    `<button class="action-button action-deactivate" onclick="toggleWalletStatus('${wallet.id}', false)">Deactivate</button>` :
                                    `<button class="action-button action-activate" onclick="toggleWalletStatus('${wallet.id}', true)">Activate</button>`
                                }
                                ${!wallet.isDefault ? 
                                    `<button class="action-button action-setdefault" onclick="setDefaultWallet('${wallet.id}')">Set Default</button>` : 
                                    ''
                                }
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            elements.walletsTableBody.innerHTML = html;
        }

        // Ï£ºÎ¨∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateOrderStatus(orderId, newStatus) {
            // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≤àÏó≠
            const statusText = {
                'ÏûÖÍ∏àÎåÄÍ∏∞': 'Waiting Deposit',
                'ÏûÖÍ∏àÌôïÏù∏': 'Deposit Confirmed',
                'Ï≤òÎ¶¨Ï§ë': 'Processing',
                'ÏôÑÎ£å': 'Completed',
                'Ï∑®ÏÜå': 'Cancelled'
            }[newStatus] || newStatus;
            
            if (!confirm(`Change order ${orderId} status to "${statusText}"?`)) {
                return;
            }
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï£ºÎ¨∏ Ï∞æÍ∏∞
            let orders = JSON.parse(localStorage.getItem('payment_orders') || '[]');
            let orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) {
                alert('Order not found');
                return;
            }
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const newStep = getStepFromStatus(newStatus);
            orders[orderIndex] = {
                ...orders[orderIndex],
                status: newStatus,
                step: newStep,
                updated: new Date().toISOString()
            };
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('payment_orders', JSON.stringify(orders));
            
            // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏïåÎ¶º
            try {
                if (window.updateOrderStatusFromAdmin) {
                    window.updateOrderStatusFromAdmin(orderId, newStatus);
                }
            } catch (e) {
                console.log('User page notification failed');
            }
            
            // Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            allOrders = orders;
            updateStats();
            updateOrders();
            
            alert(`Order status changed to "${statusText}"`);
            
            // ÏÉÅÏÑ∏ Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            if (selectedOrder && selectedOrder.id === orderId) {
                selectedOrder = orders[orderIndex];
                showOrderDetail(orderId);
            }
        }

        // ÏÉÅÌÉúÏóê Îî∞Î•∏ Îã®Í≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        function getStepFromStatus(status) {
            switch(status) {
                case 'ÏûÖÍ∏àÎåÄÍ∏∞': return 1;
                case 'ÏûÖÍ∏àÌôïÏù∏': return 2;
                case 'Ï≤òÎ¶¨Ï§ë': return 3;
                case 'ÏôÑÎ£å': return 4;
                case 'Ï∑®ÏÜå': return 1;
                default: return 1;
            }
        }

        // Ï¶ùÎ™ÖÏÑú Î≥¥Í∏∞
        function viewProof(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.proof || !order.proof.data) {
                alert('No proof document');
                return;
            }
            
            const proofWindow = window.open('', '_blank');
            proofWindow.document.write(`
                <html>
                <head>
                    <title>Payment Proof - ${order.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .info { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Payment Proof</h1>
                        <p>Order ID: ${order.id}</p>
                    </div>
                    <div class="info">
                        <p><strong>Amount:</strong> ${order.amount.toLocaleString()} THB</p>
                        <p><strong>USDT:</strong> ${order.usdt.toFixed(4)} USDT</p>
                        <p><strong>Upload Time:</strong> ${new Date(order.time).toLocaleString()}</p>
                    </div>
                    ${order.proof.type.startsWith('image/') ? 
                        `<img src="${order.proof.data}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;">` : 
                        `<p>File Name: ${order.proof.name}</p><p>File Size: ${(order.proof.size / 1024).toFixed(1)}KB</p>`
                    }
                </body>
                </html>
            `);
        }

        // Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú (ÏòÅÎ¨∏)
        function showOrderDetail(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }
            
            selectedOrder = order;
            
            const createdTime = new Date(order.time).toLocaleString('ko-KR');
            const updatedTime = order.updated ? new Date(order.updated).toLocaleString('ko-KR') : 'None';
            
            // Ï¶ùÎ™ÖÏÑú Ï†ïÎ≥¥
            let proofInfo = 'None';
            if (order.proof && order.proof.data) {
                proofInfo = order.proof.type.startsWith('image/') ? 
                    'Image file' : order.proof.name;
            }
            
            // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≤àÏó≠
            const statusText = {
                'ÏûÖÍ∏àÎåÄÍ∏∞': 'Waiting Deposit',
                'ÏûÖÍ∏àÌôïÏù∏': 'Deposit Confirmed',
                'Ï≤òÎ¶¨Ï§ë': 'Processing',
                'ÏôÑÎ£å': 'Completed',
                'Ï∑®ÏÜå': 'Cancelled'
            }[order.status] || order.status;
            
            // ÏÉÅÏÑ∏ ÎÇ¥Ïö© ÏÉùÏÑ±
            let detailHtml = `
                <div class="form-group">
                    <label class="form-label">Order ID:</label>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${order.id}</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Created Time:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${createdTime}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Updated:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${updatedTime}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Amount:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-weight: bold;">
                            ${order.amount.toLocaleString()} THB
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">USDT Amount:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            ${order.usdt.toFixed(4)} USDT
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Status:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <span class="status-badge ${order.status === 'ÏûÖÍ∏àÎåÄÍ∏∞' ? 'status-waiting' : 
                                order.status === 'ÏûÖÍ∏àÌôïÏù∏' ? 'status-confirmed' : 
                                order.status === 'Ï≤òÎ¶¨Ï§ë' ? 'status-processing' : 
                                order.status === 'ÏôÑÎ£å' ? 'status-completed' : 'status-cancelled'}">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Step:</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            ${getStepText(order.step || 1)}
                        </div>
                    </div>
                </div>
                
                ${order.wallet ? `
                <div class="form-group">
                    <label class="form-label">Deposit Wallet:</label>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${order.wallet.name} (${order.wallet.network})<br>
                        <small style="color: #718096;">${order.wallet.address}</small>
                    </div>
                </div>
                ` : ''}
                
                <div class="form-group">
                    <label class="form-label">Payment Proof:</label>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${proofInfo}
                        ${order.proof && order.proof.data ? 
                            `<button class="action-button action-view" style="margin-top: 5px;" onclick="viewProof('${order.id}')">View</button>` : ''
                        }
                    </div>
                </div>
            `;
            
            elements.orderDetailContent.innerHTML = detailHtml;
            
            // Ïï°ÏÖò Î≤ÑÌäº ÏÉùÏÑ±
            let actionsHtml = '';
            
            if (order.status === 'ÏûÖÍ∏àÎåÄÍ∏∞') {
                actionsHtml = `
                    <button class="modal-button primary" onclick="updateOrderStatus('${order.id}', 'ÏûÖÍ∏àÌôïÏù∏')">Confirm Deposit</button>
                    <button class="modal-button secondary" onclick="updateOrderStatus('${order.id}', 'Ï∑®ÏÜå')">Cancel Payment</button>
                `;
            } else if (order.status === 'ÏûÖÍ∏àÌôïÏù∏') {
                actionsHtml = `
                    <button class="modal-button primary" onclick="updateOrderStatus('${order.id}', 'Ï≤òÎ¶¨Ï§ë')">Start Process</button>
                    <button class="modal-button secondary" onclick="updateOrderStatus('${order.id}', 'Ï∑®ÏÜå')">Cancel Process</button>
                `;
            } else if (order.status === 'Ï≤òÎ¶¨Ï§ë') {
                actionsHtml = `
                    <button class="modal-button success" onclick="updateOrderStatus('${order.id}', 'ÏôÑÎ£å')">Complete Process</button>
                `;
            } else {
                actionsHtml = `
                    <button class="modal-button primary" onclick="updateOrderStatus('${order.id}', 'ÏûÖÍ∏àÎåÄÍ∏∞')">Reset Status</button>
                `;
            }
            
            elements.orderDetailActions.innerHTML = actionsHtml;
            
            // Î™®Îã¨ Ïó¥Í∏∞
            elements.orderDetailModal.classList.remove('hidden');
        }

        // Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Î™®Îã¨ Îã´Í∏∞
        function closeOrderDetail() {
            elements.orderDetailModal.classList.add('hidden');
            selectedOrder = null;
        }

        // ÏßÄÍ∞ë Ï∂îÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞
        function openAddWalletModal() {
            elements.walletModalTitle.textContent = 'üëõ Add New Wallet';
            elements.walletForm.reset();
            elements.walletId.value = '';
            qrCodeFile = null;
            
            // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            elements.walletStatus.value = 'active';
            
            elements.walletModal.classList.remove('hidden');
        }

        // ÏßÄÍ∞ë ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
        function editWallet(walletId) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet) return;
            
            selectedWallet = wallet;
            
            elements.walletModalTitle.textContent = '‚úèÔ∏è Edit Wallet';
            elements.walletId.value = wallet.id;
            elements.walletName.value = wallet.name;
            elements.walletNetwork.value = wallet.network;
            elements.walletStatus.value = wallet.isActive ? 'active' : 'inactive';
            elements.walletAddress.value = wallet.address;
            elements.walletMemo.value = wallet.memo || '';
            qrCodeFile = null;
            
            elements.walletModal.classList.remove('hidden');
        }

        // QR ÏΩîÎìú ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleQRCodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ÌååÏùº ÌÅ¨Í∏∞ Ï†úÌïú (2MB)
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File size must be less than 2MB');
                event.target.value = '';
                return;
            }
            
            // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏
            if (!file.type.startsWith('image/')) {
                alert('Only image files can be uploaded');
                event.target.value = '';
                return;
            }
            
            qrCodeFile = file;
        }

        // ÏßÄÍ∞ë Ï†ÄÏû• - FIXED VERSION
        function saveWallet() {
            console.log('Save wallet button clicked');
            
            // Ìèº Í≤ÄÏ¶ù
            if (!elements.walletName.value.trim()) {
                alert('Please enter wallet name');
                return;
            }
            
            if (!elements.walletNetwork.value) {
                alert('Please select network');
                return;
            }
            
            if (!elements.walletAddress.value.trim()) {
                alert('Please enter wallet address');
                return;
            }
            
            const walletId = elements.walletId.value;
            const isEdit = !!walletId;
            
            // QR ÏΩîÎìú ÌååÏùº Ï≤òÎ¶¨
            if (qrCodeFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveWalletData(e.target.result);
                };
                reader.readAsDataURL(qrCodeFile);
            } else {
                // QR ÏΩîÎìú ÏóÜÏù¥ Ï†ÄÏû•
                saveWalletData(isEdit ? (selectedWallet?.qrCode || null) : null);
            }
            
            function saveWalletData(qrCodeData) {
                const walletData = {
                    id: isEdit ? walletId : 'wallet_' + Date.now(),
                    name: elements.walletName.value.trim(),
                    network: elements.walletNetwork.value,
                    address: elements.walletAddress.value.trim(),
                    qrCode: qrCodeData,
                    isActive: elements.walletStatus.value === 'active',
                    isDefault: isEdit ? (selectedWallet?.isDefault || false) : false,
                    memo: elements.walletMemo.value.trim(),
                    createdAt: isEdit ? (selectedWallet?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                console.log('Wallet data to save:', walletData);
                
                // ÏßÄÍ∞ë Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                let updatedWallets = [...allWallets];
                
                if (isEdit) {
                    // ÏàòÏ†ï Î™®Îìú
                    const index = updatedWallets.findIndex(w => w.id === walletId);
                    if (index > -1) {
                        updatedWallets[index] = walletData;
                    }
                } else {
                    // Ï∂îÍ∞Ä Î™®Îìú
                    updatedWallets.push(walletData);
                }
                
                // ÌôúÏÑ±ÌôîÎêú ÏßÄÍ∞ëÏù¥ Ïó¨Îü¨ Í∞úÏù∏ÏßÄ ÌôïÏù∏
                const activeWallets = updatedWallets.filter(w => w.isActive);
                if (activeWallets.length === 0 && updatedWallets.length > 0) {
                    // ÌôúÏÑ±ÌôîÎêú ÏßÄÍ∞ëÏù¥ ÏóÜÏúºÎ©¥ Ï≤´ Î≤àÏß∏ ÏßÄÍ∞ëÏùÑ ÌôúÏÑ±Ìôî
                    updatedWallets[0].isActive = true;
                }
                
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
                localStorage.setItem('payment_wallets', JSON.stringify(updatedWallets));
                
                // ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                allWallets = updatedWallets;
                updateStats();
                updateWallets();
                
                // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
                notifyUserPageWalletsUpdate();
                
                // Î™®Îã¨ Îã´Í∏∞
                closeWalletModal();
                
                alert(`Wallet ${isEdit ? 'updated' : 'added'} successfully`);
            }
        }

        // ÏßÄÍ∞ë ÏÉÅÌÉú ÌÜ†Í∏Ä
        function toggleWalletStatus(walletId, activate) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet) return;
            
            if (wallet.isDefault && !activate) {
                alert('Default wallet cannot be deactivated');
                return;
            }
            
            const action = activate ? 'Activate' : 'Deactivate';
            if (!confirm(`${action} this wallet?`)) {
                return;
            }
            
            // ÏßÄÍ∞ë ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const updatedWallets = allWallets.map(w => {
                if (w.id === walletId) {
                    return { ...w, isActive: activate };
                }
                return w;
            });
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('payment_wallets', JSON.stringify(updatedWallets));
            
            // ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            allWallets = updatedWallets;
            updateStats();
            updateWallets();
            
            // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
            notifyUserPageWalletsUpdate();
            
            alert(`Wallet ${action.toLowerCase()}d`);
        }

        // Í∏∞Î≥∏ ÏßÄÍ∞ë ÏÑ§Ï†ï
        function setDefaultWallet(walletId) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet) return;
            
            if (!confirm(`Set this wallet as default?\n\nDefault wallet cannot be deleted and is always active.`)) {
                return;
            }
            
            // Î™®Îì† ÏßÄÍ∞ëÏùò Í∏∞Î≥∏ ÏÑ§Ï†ï Ìï¥Ï†ú ÌõÑ ÏÑ†ÌÉùÌïú ÏßÄÍ∞ëÎßå Í∏∞Î≥∏ ÏÑ§Ï†ï
            const updatedWallets = allWallets.map(w => {
                if (w.id === walletId) {
                    return { ...w, isDefault: true, isActive: true };
                } else {
                    return { ...w, isDefault: false };
                }
            });
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('payment_wallets', JSON.stringify(updatedWallets));
            
            // ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            allWallets = updatedWallets;
            updateStats();
            updateWallets();
            
            // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
            notifyUserPageWalletsUpdate();
            
            alert('Default wallet set');
        }

        // ÏßÄÍ∞ë ÏÇ≠Ï†ú
        function deleteWallet(walletId) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet) return;
            
            if (wallet.isDefault) {
                alert('Default wallet cannot be deleted');
                return;
            }
            
            // Ïù¥ ÏßÄÍ∞ëÏùÑ ÏÇ¨Ïö©ÌïòÎäî Ï£ºÎ¨∏Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            const ordersUsingWallet = allOrders.filter(o => 
                o.wallet && o.wallet.id === walletId && o.status !== 'ÏôÑÎ£å' && o.status !== 'Ï∑®ÏÜå'
            );
            
            if (ordersUsingWallet.length > 0) {
                alert(`There are ${ordersUsingWallet.length} active orders using this wallet.\nPlease change their status first.`);
                return;
            }
            
            if (!confirm(`Delete this wallet?\n\nCannot be recovered after deletion.`)) {
                return;
            }
            
            // ÏßÄÍ∞ë ÏÇ≠Ï†ú
            const updatedWallets = allWallets.filter(w => w.id !== walletId);
            
            // ÌôúÏÑ±ÌôîÎêú ÏßÄÍ∞ëÏù¥ ÏóÜÏúºÎ©¥ Ï≤´ Î≤àÏß∏ ÏßÄÍ∞ë ÌôúÏÑ±Ìôî
            const activeWallets = updatedWallets.filter(w => w.isActive);
            if (activeWallets.length === 0 && updatedWallets.length > 0) {
                updatedWallets[0].isActive = true;
            }
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('payment_wallets', JSON.stringify(updatedWallets));
            
            // ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            allWallets = updatedWallets;
            updateStats();
            updateWallets();
            
            // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
            notifyUserPageWalletsUpdate();
            
            alert('Wallet deleted');
        }

        // ÏßÄÍ∞ë Î™®Îã¨ Îã´Í∏∞
        function closeWalletModal() {
            elements.walletModal.classList.add('hidden');
            selectedWallet = null;
            qrCodeFile = null;
        }

        // Ïú†Ï†Ä ÌéòÏù¥ÏßÄÏóê ÏßÄÍ∞ë Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
        function notifyUserPageWalletsUpdate() {
            try {
                if (window.updateWalletsFromAdmin) {
                    window.updateWalletsFromAdmin(allWallets);
                }
            } catch (e) {
                console.log('User page wallet update notification failed');
            }
        }

        // Ï£ºÎ¨∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌååÏùº Ï†ÄÏû• ÏúÑÏπò ÏïåÎ¶º)
        function exportOrdersToExcel() {
            try {
                let csv = 'Order ID,Created Time,Amount(THB),USDT Amount,Status,Step,Wallet,Network,Proof,Updated Time\n';
                
                allOrders.forEach(order => {
                    const time = new Date(order.time).toLocaleString('ko-KR');
                    const updated = order.updated ? new Date(order.updated).toLocaleString('ko-KR') : '';
                    const stepText = getStepText(order.step || 1);
                    const walletInfo = order.wallet ? `${order.wallet.name} (${order.wallet.network})` : 'Not specified';
                    const hasProof = order.proof && order.proof.data ? 'Yes' : 'No';
                    
                    csv += `"${order.id}","${time}","${order.amount}","${order.usdt || 0}","${order.status}","${stepText}","${walletInfo}","${order.wallet?.network || ''}","${hasProof}","${updated}"\n`;
                });
                
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // ÌååÏùºÎ™Ö ÏÉùÏÑ±
                const fileName = `orders_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ÌååÏùº Ï†ÄÏû• ÏúÑÏπò ÏïåÎ¶º
                showSaveStatus(`File saved as: ${fileName}\n\nIt will be saved to your default download folder.`);
                
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed');
            }
        }

        // Ï†ÄÏû• ÏÉÅÌÉú ÌëúÏãú
        function showSaveStatus(message) {
            elements.saveStatus.textContent = message;
            elements.saveStatus.classList.add('show');
            
            setTimeout(() => {
                elements.saveStatus.classList.remove('show');
            }, 3000);
        }

        // ÌÖåÏä§Ìä∏ Ï£ºÎ¨∏ ÏÉùÏÑ±
        window.createTestOrder = function() {
            const activeWallet = allWallets.find(w => w.isActive) || allWallets[0];
            const testOrder = {
                id: 'ORD-' + Date.now().toString().slice(-6),
                amount: Math.floor(Math.random() * 10000) + 1000,
                usdt: Math.random() * 100 + 10,
                status: 'ÏûÖÍ∏àÎåÄÍ∏∞',
                step: 1,
                time: new Date().toISOString(),
                wallet: activeWallet ? {
                    id: activeWallet.id,
                    name: activeWallet.name,
                    address: activeWallet.address,
                    network: activeWallet.network
                } : null
            };
            
            let orders = JSON.parse(localStorage.getItem('payment_orders') || '[]');
            orders.unshift(testOrder);
            
            if (orders.length > 50) {
                orders = orders.slice(0, 50);
            }
            
            localStorage.setItem('payment_orders', JSON.stringify(orders));
            loadAllData();
            
            alert(`Test order ${testOrder.id} created`);
        };

        // Î™®Îì† Ï£ºÎ¨∏ ÏÇ≠Ï†ú
        window.clearAllOrders = function() {
            if (confirm('Delete all order records? This cannot be undone.')) {
                localStorage.removeItem('payment_orders');
                allOrders = [];
                updateStats();
                updateOrders();
                alert('All order records deleted');
            }
        };

        // Î™®Îì† ÏßÄÍ∞ë ÏÇ≠Ï†ú (Í∏∞Î≥∏ ÏßÄÍ∞ë Ï†úÏô∏)
        window.clearAllWallets = function() {
            if (confirm('Delete all wallets except default wallet? This cannot be undone.')) {
                const defaultWallet = allWallets.find(w => w.isDefault);
                const updatedWallets = defaultWallet ? [defaultWallet] : [];
                
                localStorage.setItem('payment_wallets', JSON.stringify(updatedWallets));
                allWallets = updatedWallets;
                updateStats();
                updateWallets();
                notifyUserPageWalletsUpdate();
                
                alert('All wallets deleted (except default wallet)');
            }
        };
    </script>
</body>
</html>
