<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT/THB Payment System - Anonymous Payment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Apple SD Gothic Neo', -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            padding-top: 50px;
        }

        .language-container {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .language-toggle-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .language-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .language-toggle-btn:active {
            transform: translateY(0);
        }

        .lang-icon {
            font-size: 16px;
        }

        .title {
            color: #1a2980;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #4a5568;
            font-size: 14px;
        }

        .exchange-section {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            color: #2d3748;
            text-align: center;
        }

        .rate-display {
            font-size: 22px;
            font-weight: bold;
            color: #2d3748;
            margin: 10px 0;
        }

        .rate-value {
            color: #e53e3e;
        }

        .payment-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-label {
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }

        .amount-input {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            text-align: center;
            outline: none;
        }

        .amount-input:focus {
            border-color: #667eea;
        }

        .amount-limit {
            font-size: 14px;
            color: #718096;
            text-align: center;
            margin-top: 5px;
        }

        .calculation-preview {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 15px;
            color: #4a5568;
        }

        .calc-total {
            font-weight: bold;
            color: #2d3748;
            font-size: 18px;
        }

        .upload-section {
            margin: 20px 0;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            width: 100%;
        }

        .upload-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2d3748;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            border: 2px dashed #cbd5e0;
            text-align: center;
            cursor: pointer;
            width: 100%;
            display: block;
            transition: all 0.3s;
        }

        .upload-button:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .upload-input {
            display: none;
        }

        .upload-preview {
            margin-top: 10px;
            text-align: center;
        }

        .upload-preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            object-fit: contain;
        }

        .file-info {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .pay-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .pay-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .pay-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .orders-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .section-title {
            color: #2d3748;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .order-card.status-waiting { border-color: #f6ad55; }
        .order-card.status-confirmed { border-color: #4299e1; }
        .order-card.status-processing { border-color: #9f7aea; }
        .order-card.status-completed { border-color: #38a169; }
        .order-card.status-cancelled { border-color: #e53e3e; }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-id {
            font-weight: bold;
            color: #2d3748;
            font-size: 16px;
        }

        .order-time {
            font-size: 12px;
            color: #718096;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .status-waiting { background: #f6ad55; }
        .status-confirmed { background: #4299e1; }
        .status-processing { background: #9f7aea; }
        .status-completed { background: #38a169; }
        .status-cancelled { background: #e53e3e; }

        .order-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-amount {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            text-align: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .order-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #4a5568;
        }

        .proof-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .no-orders {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
            font-size: 16px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #cbd5e0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            color: #2d3748;
            font-size: 24px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #718096;
            cursor: pointer;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #718096;
            z-index: 1;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .step-circle.completed {
            background: #38a169;
            color: white;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            background: #f7fafc;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e2e8f0;
        }

        .qr-code img {
            max-width: 100%;
            max-height: 100%;
        }

        .qr-placeholder {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .wallet-address {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid #e2e8f0;
        }

        .wallet-info {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #f0fff4;
            border-radius: 8px;
            border: 1px solid #c6f6d5;
        }

        .wallet-name {
            font-weight: bold;
            color: #2d3748;
        }

        .copy-button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .timer {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            padding: 20px;
            border-radius: 15px;
            font-size: 22px;
            color: white;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .complete-message {
            text-align: center;
            font-size: 24px;
            color: #38a169;
            font-weight: bold;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .status-update-message {
            text-align: center;
            padding: 15px;
            background: #f0fff4;
            border-radius: 10px;
            margin: 15px 0;
            color: #2d3748;
            font-size: 14px;
            border: 1px solid #c6f6d5;
        }

        .step-description {
            text-align: center;
            color: #4a5568;
            margin-bottom: 20px;
        }

        .wallet-selection {
            margin: 15px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .wallet-selection-title {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .selected-wallet {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #c6f6d5;
        }

        .wallet-icon {
            font-size: 20px;
        }

        .wallet-details {
            flex: 1;
        }

        .wallet-network {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .network-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-left: 5px;
        }

        .network-trc20 { background: #f56565; }
        .network-erc20 { background: #4299e1; }
        .network-bep20 { background: #38a169; }

        .completed-orders-section {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .completed-section-title {
            color: #38a169;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .completed-section-title::before {
            content: 'âœ“';
            background: #38a169;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .language-switch-wrapper {
            user-select: none;
        }
        
        .rate-loading {
            color: #718096;
            font-size: 16px;
        }
        
        .rate-error {
            color: #e53e3e;
            font-size: 16px;
        }
        
        .upload-required {
            color: #e53e3e;
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
        }
        
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #38a169;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sync-status.visible {
            opacity: 1;
        }
        
        .sync-pulse {
            width: 8px;
            height: 8px;
            background: #38a169;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- ë™ê¸°í™” ìƒíƒœ í‘œì‹œ -->
    <div class="sync-status" id="syncStatus">
        <div class="sync-pulse"></div>
        <span id="syncText">ë™ê¸°í™” ì¤‘...</span>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="language-container">
                <button class="language-toggle-btn" id="languageToggleBtn">
                    <span class="lang-icon">ğŸŒ</span>
                    <span id="languageBtnText">English</span>
                </button>
            </div>
            <h1 class="title" id="pageTitle">USDT â†’ THB ìµëª… ê²°ì œ</h1>
            <p class="subtitle" id="pageSubtitle">ë¡œê·¸ì¸ ì—†ì´ USDTë¡œ íƒœêµ­ ë°”íŠ¸(THB) ê²°ì œí•˜ê¸°</p>
        </div>

        <div class="exchange-section">
            <h4 id="exchangeTitle">ğŸ’± ì‹¤ì‹œê°„ í™˜ìœ¨</h4>
            <div class="rate-display">
                1 USDT = <span class="rate-value" id="exchangeRate">
                    <span class="rate-loading">ë¡œë”© ì¤‘...</span>
                </span> THB
            </div>
            <div id="rateUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ë¡œë”© ì¤‘...</div>
        </div>

        <div class="payment-form">
            <div class="input-group">
                <label class="input-label" id="amountLabel">ğŸ’° ê²°ì œ ê¸ˆì•¡ ì…ë ¥ (THB):</label>
                <input type="number" 
                       class="amount-input" 
                       id="thbAmount" 
                       placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”"
                       min="1000"
                       max="500000"
                       value="">
                <div class="amount-limit" id="amountLimit">
                    ìµœì†Œ 1,000 THB ~ ìµœëŒ€ 500,000 THB
                </div>
            </div>

            <div class="calculation-preview" id="calcPreview" style="display: none;">
                <div class="calc-row">
                    <span id="calcAmountLabel">ê²°ì œ ê¸ˆì•¡:</span>
                    <span id="calcAmount">0 THB</span>
                </div>
                <div class="calc-row">
                    <span id="calcRateLabel">í™˜ìœ¨:</span>
                    <span>1 USDT = <span id="calcRate">0.00</span> THB</span>
                </div>
                <div class="calc-row">
                    <span id="calcUsdtLabel">USDT ê¸ˆì•¡:</span>
                    <span id="calcUsdt">0.0000 USDT</span>
                </div>
                <div class="calc-row">
                    <span id="calcFeeLabel">ìˆ˜ìˆ˜ë£Œ (3%):</span>
                    <span id="calcFee">0.0000 USDT</span>
                </div>
                <div class="calc-row">
                    <span id="calcTotalLabel">ì´ ê²°ì œ ê¸ˆì•¡:</span>
                    <span class="calc-total" id="calcTotal">0.0000 USDT</span>
                </div>
            </div>

            <div class="upload-section">
                <label class="upload-label" for="paymentProof">
                    <div class="upload-button" id="uploadButtonText">
                        ğŸ“ ê²°ì œ ì¦ëª…ì„œ ì—…ë¡œë“œ (í•„ìˆ˜)
                    </div>
                </label>
                <div class="upload-required" id="uploadRequired">
                    â€» ê²°ì œë¥¼ ìœ„í•´ QR ì½”ë“œ ìŠ¤í¬ë¦°ìƒ·ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤
                </div>
                <input type="file" class="upload-input" id="paymentProof" accept="image/*,.pdf,.png,.jpg,.jpeg">
                <div class="upload-preview" id="uploadPreview">
                    <!-- ì´ˆê¸°ì—ëŠ” ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ -->
                </div>
            </div>

            <button class="pay-button" id="payButton" disabled>
                ğŸ’³ <span id="payButtonText">ì§€ê¸ˆ ê²°ì œí•˜ê¸°</span>
            </button>
        </div>

        <div class="orders-section">
            <h3 class="section-title">â³ <span id="activeOrdersTitle">ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸</span></h3>
            <div class="orders-list" id="activeOrdersList">
                <div class="no-orders" id="noActiveOrders">ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>

        <div class="completed-orders-section">
            <h3 class="completed-section-title">
                <span id="completedOrdersTitle">âœ… ì™„ë£Œëœ ì£¼ë¬¸</span>
            </h3>
            <div class="orders-list" id="completedOrdersList">
                <div class="no-orders" id="noCompletedOrders">ì™„ë£Œëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ğŸ”³ USDT ì „ì†¡ ì•ˆë‚´</h3>
                <button class="modal-close" id="closeModal">âœ•</button>
            </div>

            <div class="step-indicator">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-circle" id="step2">2</div>
                <div class="step-circle" id="step3">3</div>
                <div class="step-circle" id="step4">4</div>
            </div>

            <div id="step1Content">
                <div class="wallet-selection" id="walletSelection">
                    <div class="wallet-selection-title" id="walletSelectionTitle">ì„ íƒëœ ì§€ê°‘:</div>
                    <div class="selected-wallet" id="selectedWalletInfo">
                        <div class="wallet-icon">ğŸ‘›</div>
                        <div class="wallet-details">
                            <div class="wallet-name">ê¸°ë³¸ ì§€ê°‘ (TRC20)</div>
                            <div class="wallet-network">TRC20 Network</div>
                        </div>
                    </div>
                </div>

                <div class="qr-container">
                    <div class="qr-code" id="qrCodeContainer">
                        <div class="qr-placeholder">ğŸ”³</div>
                    </div>
                    <p class="step-description" id="step1Description">ì•„ë˜ ì§€ê°‘ ì£¼ì†Œë¡œ USDTë¥¼ ì „ì†¡í•´ì£¼ì„¸ìš”</p>
                </div>
                
                <div class="wallet-address" id="walletAddress">
                    TXYZ1234567890abcdefghijklmnopqrstuvw
                </div>
                
                <button class="copy-button" id="copyAddress">
                    ğŸ“‹ <span id="copyButtonText">ì£¼ì†Œ ë³µì‚¬</span>
                </button>

                <div class="calculation-preview" style="margin-top: 20px;">
                    <div class="calc-row">
                        <span id="modalTotalLabel">ì´ ê²°ì œ ê¸ˆì•¡:</span>
                        <span class="calc-total" id="modalTotal">0.0000 USDT</span>
                    </div>
                    <div class="calc-row">
                        <span id="orderIdLabel">ì£¼ë¬¸ ID:</span>
                        <span id="orderId">ORD-000000</span>
                    </div>
                </div>

                <div class="status-update-message" id="statusMessage1">
                    â³ <span id="statusMessage1Text">USDT ì „ì†¡ í›„ ê´€ë¦¬ì í™•ì¸ ëŒ€ê¸° ì¤‘...</span>
                </div>
            </div>

            <div id="step2Content" style="display: none;">
                <div class="spinner"></div>
                <p class="step-description" id="step2Description">USDT ì…ê¸ˆ í™•ì¸ ì¤‘...</p>
                <div class="status-update-message" id="statusMessage2">
                    <span id="statusMessage2Text">ê´€ë¦¬ìê°€ ì…ê¸ˆì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
                </div>
            </div>

            <div id="step3Content" style="display: none;">
                <div class="spinner" style="border-top-color: #f6ad55;"></div>
                <p class="step-description" id="step3Description">THB ê²°ì œ ì²˜ë¦¬ ì¤‘...</p>
                <div class="status-update-message" id="statusMessage3">
                    <span id="statusMessage3Text">THB ê²°ì œê°€ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
            </div>

            <div id="step4Content" style="display: none;">
                <div class="complete-message">ğŸ‰ <span id="completeMessage">ê²°ì œ ì™„ë£Œ!</span></div>
                <p class="step-description" id="step4Description">ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <button class="pay-button" id="finishPayment">
                    <span id="finishButtonText">í™•ì¸</span>
                </button>
            </div>

            <div class="timer" id="timer">
                â° <span id="timerLabel">ë‚¨ì€ ì‹œê°„:</span> <span id="timeLeft">5:00</span>
            </div>

            <div class="status-update-message" id="autoUpdateInfo">
                ğŸ”„ <span id="autoUpdateText">ê´€ë¦¬ì í™•ì¸ í›„ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤...</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== ë°ì´í„° ê´€ë¦¬ì í´ë˜ìŠ¤ ====================
        class DataManager {
            constructor() {
                this.ORDERS_KEY = 'payment_orders';
                this.WALLETS_KEY = 'payment_wallets';
                this.SYNC_KEY = 'payment_sync_flag';
                this.USER_SYNC_KEY = 'user_sync_check';
            }

            // ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            getOrders() {
                try {
                    let orders = JSON.parse(localStorage.getItem(this.ORDERS_KEY) || '[]');
                    
                    // sessionStorageì—ë„ ë³µì‚¬ (ì‚¬ìš©ì í˜ì´ì§€ì—ì„œ ë¹ ë¥´ê²Œ ì ‘ê·¼)
                    sessionStorage.setItem(this.ORDERS_KEY, JSON.stringify(orders));
                    
                    return orders;
                } catch (error) {
                    console.error('Error loading orders:', error);
                    return [];
                }
            }

            // ì£¼ë¬¸ ë°ì´í„° ì €ì¥í•˜ê¸°
            saveOrders(orders) {
                try {
                    // localStorageì— ì €ì¥ (ê´€ë¦¬ìì™€ ê³µìœ )
                    localStorage.setItem(this.ORDERS_KEY, JSON.stringify(orders));
                    
                    // sessionStorageì—ë„ ì €ì¥ (ì‚¬ìš©ì í˜ì´ì§€ì—ì„œ ë¹ ë¥¸ ì ‘ê·¼)
                    sessionStorage.setItem(this.ORDERS_KEY, JSON.stringify(orders));
                    
                    // ë™ê¸°í™” í”Œë˜ê·¸ ì„¤ì •
                    localStorage.setItem(this.SYNC_KEY, Date.now().toString());
                    
                    return true;
                } catch (error) {
                    console.error('Error saving orders:', error);
                    return false;
                }
            }

            // ì§€ê°‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            getWallets() {
                try {
                    // í•­ìƒ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    let wallets = JSON.parse(localStorage.getItem(this.WALLETS_KEY) || '[]');
                    
                    // ì§€ê°‘ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì§€ê°‘ ìƒì„±
                    if (wallets.length === 0) {
                        wallets = [this.createDefaultWallet()];
                        this.saveWallets(wallets);
                    }
                    
                    return wallets;
                } catch (error) {
                    console.error('Error loading wallets:', error);
                    return [];
                }
            }

            // ì§€ê°‘ ë°ì´í„° ì €ì¥í•˜ê¸°
            saveWallets(wallets) {
                try {
                    localStorage.setItem(this.WALLETS_KEY, JSON.stringify(wallets));
                    localStorage.setItem(this.SYNC_KEY, Date.now().toString());
                    return true;
                } catch (error) {
                    console.error('Error saving wallets:', error);
                    return false;
                }
            }

            // ê¸°ë³¸ ì§€ê°‘ ìƒì„±
            createDefaultWallet() {
                return {
                    id: 'wallet_1',
                    name: 'ê¸°ë³¸ ì§€ê°‘ (TRC20)',
                    address: 'TXYZ1234567890abcdefghijklmnopqrstuvw',
                    network: 'TRC20',
                    qrCode: null,
                    isActive: true,
                    isDefault: true,
                    createdAt: new Date().toISOString()
                };
            }

            // ìƒˆë¡œìš´ ì£¼ë¬¸ ID ìƒì„±
            generateOrderId() {
                return 'ORD-' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
            }

            // í™œì„± ì§€ê°‘ ì°¾ê¸°
            getActiveWallet() {
                const wallets = this.getWallets();
                return wallets.find(w => w.isActive) || wallets[0];
            }

            // ë™ê¸°í™” ì²´í¬
            checkSync() {
                return localStorage.getItem(this.SYNC_KEY);
            }

            // ì‚¬ìš©ì ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
            updateUserSync() {
                const syncTime = this.checkSync();
                sessionStorage.setItem(this.USER_SYNC_KEY, syncTime || '0');
                return syncTime;
            }

            // ë™ê¸°í™” í•„ìš” ì—¬ë¶€ ì²´í¬
            needsSync() {
                const lastSync = this.checkSync();
                const lastUserSync = sessionStorage.getItem(this.USER_SYNC_KEY) || '0';
                return lastSync !== lastUserSync;
            }
        }

        // ==================== ì „ì—­ ë³€ìˆ˜ ë° DataManager ì¸ìŠ¤í„´ìŠ¤ ====================
        const dataManager = new DataManager();
        
        // ìƒíƒœ ê´€ë¦¬
        let exchangeRate = 0;
        let timeLeft = 300;
        let timerInterval = null;
        let currentStep = 1;
        let currentOrderId = '';
        let statusCheckInterval = null;
        let uploadedFile = null;
        let activeWallet = null;
        let allWallets = [];
        let allOrders = [];
        let currentLang = 'ko';
        let syncCheckInterval = null;

        // ë²ˆì—­ ë°ì´í„°
        const translations = {
            en: {
                title: "USDT â†’ THB Anonymous Payment",
                subtitle: "Pay with USDT to Thai Baht (THB) without login",
                exchangeTitle: "ğŸ’± Real-time Exchange Rate",
                lastUpdate: "Last update: ",
                amountLabel: "ğŸ’° Enter payment amount (THB):",
                amountLimit: "Minimum 1,000 THB ~ Maximum 500,000 THB",
                calcAmountLabel: "Payment Amount:",
                calcRateLabel: "Exchange Rate:",
                calcUsdtLabel: "USDT Amount:",
                calcFeeLabel: "Fee (3%):",
                calcTotalLabel: "Total Payment:",
                uploadText: "Upload payment proof (Required)",
                uploadRequired: "â€» QR code screenshot must be uploaded for payment",
                payNow: "Pay Now",
                activeOrders: "My Active Orders",
                completedOrders: "âœ… Completed Orders",
                noActiveOrders: "No active orders",
                noCompletedOrders: "No completed orders",
                modalTitle: "ğŸ”³ USDT Transfer Guide",
                walletSelectionTitle: "Selected Wallet:",
                step1Description: "Send USDT to the wallet address below",
                copyButtonText: "Copy Address",
                modalTotalLabel: "Total Payment:",
                orderIdLabel: "Order ID:",
                statusMessage1Text: "Waiting for admin confirmation after USDT transfer...",
                step2Description: "Verifying USDT deposit...",
                statusMessage2Text: "Admin is confirming the deposit. Please wait...",
                step3Description: "Processing THB payment...",
                statusMessage3Text: "THB payment is being processed...",
                completeMessage: "Payment Completed!",
                step4Description: "Payment has been successfully completed.",
                finishButtonText: "Confirm",
                timerLabel: "Time left:",
                autoUpdateText: "Will proceed automatically after admin confirmation...",
                waitingDeposit: "Waiting Deposit",
                depositConfirmed: "Deposit Confirmed",
                processing: "Processing",
                completed: "Completed",
                cancelled: "Cancelled",
                rateLoading: "Loading...",
                rateError: "Failed to load rate",
                uploadRequiredAlert: "Please upload payment proof (QR code screenshot) first",
                amountMinAlert: "Minimum payment amount is 1,000 THB",
                amountMaxAlert: "Maximum payment amount is 500,000 THB",
                languageBtnText: "í•œêµ­ì–´",
                syncText: "Syncing..."
            },
            ko: {
                title: "USDT â†’ THB ìµëª… ê²°ì œ",
                subtitle: "ë¡œê·¸ì¸ ì—†ì´ USDTë¡œ íƒœêµ­ ë°”íŠ¸(THB) ê²°ì œí•˜ê¸°",
                exchangeTitle: "ğŸ’± ì‹¤ì‹œê°„ í™˜ìœ¨",
                lastUpdate: "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ",
                amountLabel: "ğŸ’° ê²°ì œ ê¸ˆì•¡ ì…ë ¥ (THB):",
                amountLimit: "ìµœì†Œ 1,000 THB ~ ìµœëŒ€ 500,000 THB",
                calcAmountLabel: "ê²°ì œ ê¸ˆì•¡:",
                calcRateLabel: "í™˜ìœ¨:",
                calcUsdtLabel: "USDT ê¸ˆì•¡:",
                calcFeeLabel: "ìˆ˜ìˆ˜ë£Œ (3%):",
                calcTotalLabel: "ì´ ê²°ì œ ê¸ˆì•¡:",
                uploadText: "ê²°ì œ ì¦ëª…ì„œ ì—…ë¡œë“œ (í•„ìˆ˜)",
                uploadRequired: "â€» ê²°ì œë¥¼ ìœ„í•´ QR ì½”ë“œ ìŠ¤í¬ë¦°ìƒ·ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤",
                payNow: "ì§€ê¸ˆ ê²°ì œí•˜ê¸°",
                activeOrders: "ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸",
                completedOrders: "âœ… ì™„ë£Œëœ ì£¼ë¬¸",
                noActiveOrders: "ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤",
                noCompletedOrders: "ì™„ë£Œëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤",
                modalTitle: "ğŸ”³ USDT ì „ì†¡ ì•ˆë‚´",
                walletSelectionTitle: "ì„ íƒëœ ì§€ê°‘:",
                step1Description: "ì•„ë˜ ì§€ê°‘ ì£¼ì†Œë¡œ USDTë¥¼ ì „ì†¡í•´ì£¼ì„¸ìš”",
                copyButtonText: "ì£¼ì†Œ ë³µì‚¬",
                modalTotalLabel: "ì´ ê²°ì œ ê¸ˆì•¡:",
                orderIdLabel: "ì£¼ë¬¸ ID:",
                statusMessage1Text: "USDT ì „ì†¡ í›„ ê´€ë¦¬ì í™•ì¸ ëŒ€ê¸° ì¤‘...",
                step2Description: "USDT ì…ê¸ˆ í™•ì¸ ì¤‘...",
                statusMessage2Text: "ê´€ë¦¬ìê°€ ì…ê¸ˆì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...",
                step3Description: "THB ê²°ì œ ì²˜ë¦¬ ì¤‘...",
                statusMessage3Text: "THB ê²°ì œê°€ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...",
                completeMessage: "ê²°ì œ ì™„ë£Œ!",
                step4Description: "ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                finishButtonText: "í™•ì¸",
                timerLabel: "ë‚¨ì€ ì‹œê°„:",
                autoUpdateText: "ê´€ë¦¬ì í™•ì¸ í›„ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤...",
                waitingDeposit: "ì…ê¸ˆëŒ€ê¸°",
                depositConfirmed: "ì…ê¸ˆí™•ì¸",
                processing: "ì²˜ë¦¬ì¤‘",
                completed: "ì™„ë£Œ",
                cancelled: "ì·¨ì†Œ",
                rateLoading: "ë¡œë”© ì¤‘...",
                rateError: "í™˜ìœ¨ ë¡œë”© ì‹¤íŒ¨",
                uploadRequiredAlert: "ë¨¼ì € ê²°ì œ ì¦ëª…ì„œ(QR ì½”ë“œ ìŠ¤í¬ë¦°ìƒ·)ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”",
                amountMinAlert: "ìµœì†Œ ê²°ì œ ê¸ˆì•¡ì€ 1,000 THB ì…ë‹ˆë‹¤",
                amountMaxAlert: "ìµœëŒ€ ê²°ì œ ê¸ˆì•¡ì€ 500,000 THB ì…ë‹ˆë‹¤",
                languageBtnText: "English",
                syncText: "ë™ê¸°í™” ì¤‘..."
            }
        };

        // ==================== í˜ì´ì§€ ì´ˆê¸°í™” ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ì‚¬ìš©ì í˜ì´ì§€ ë¡œë“œë¨');
            
            // í˜„ì¬ ì–¸ì–´ ì„¤ì •
            currentLang = 'ko';
            
            // ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
            initLanguageButton();
            updateLanguageButtonText();
            updateAllText();
            
            // ì‹¤ì‹œê°„ í™˜ìœ¨ ì—…ë°ì´íŠ¸
            fetchRealTimeExchangeRate();
            setInterval(fetchRealTimeExchangeRate, 10000);
            
            // ë°ì´í„° ë¡œë“œ
            loadInitialData();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // ë™ê¸°í™” ì²´í¬ ì‹œì‘
            startSyncCheck();
            
            console.log('ì‚¬ìš©ì í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ==================== ë°ì´í„° ë¡œë“œ ====================
        function loadInitialData() {
            // ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ
            allOrders = dataManager.getOrders();
            console.log('ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ:', allOrders.length, 'ê°œ');
            
            // ì§€ê°‘ ë°ì´í„° ë¡œë“œ
            allWallets = dataManager.getWallets();
            activeWallet = dataManager.getActiveWallet();
            console.log('ì§€ê°‘ ë°ì´í„° ë¡œë“œ:', allWallets.length, 'ê°œ');
            
            // UI ì—…ë°ì´íŠ¸
            updateOrdersList();
            updateWalletDisplay();
            
            // ì´ˆê¸° ê²°ì œ ë²„íŠ¼ ìƒíƒœ í™•ì¸
            checkPaymentButton();
            
            // ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
            dataManager.updateUserSync();
        }

        // ==================== ì–¸ì–´ ê´€ë ¨ í•¨ìˆ˜ ====================
        function initLanguageButton() {
            const languageBtn = document.getElementById('languageToggleBtn');
            if (!languageBtn) return;
            
            languageBtn.addEventListener('click', toggleLanguage);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ko' : 'en';
            updateLanguageButtonText();
            updateAllText();
        }

        function updateLanguageButtonText() {
            const trans = translations[currentLang];
            const btnText = document.getElementById('languageBtnText');
            if (btnText && trans) {
                btnText.textContent = trans.languageBtnText;
            }
        }

        function updateAllText() {
            const trans = translations[currentLang];
            
            // í˜ì´ì§€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('pageTitle').textContent = trans.title;
            document.getElementById('pageSubtitle').textContent = trans.subtitle;
            document.getElementById('exchangeTitle').textContent = trans.exchangeTitle;
            document.getElementById('amountLabel').textContent = trans.amountLabel;
            document.getElementById('amountLimit').textContent = trans.amountLimit;
            document.getElementById('calcAmountLabel').textContent = trans.calcAmountLabel;
            document.getElementById('calcRateLabel').textContent = trans.calcRateLabel;
            document.getElementById('calcUsdtLabel').textContent = trans.calcUsdtLabel;
            document.getElementById('calcFeeLabel').textContent = trans.calcFeeLabel;
            document.getElementById('calcTotalLabel').textContent = trans.calcTotalLabel;
            document.getElementById('uploadRequired').textContent = trans.uploadRequired;
            document.getElementById('payButtonText').textContent = trans.payNow;
            document.getElementById('activeOrdersTitle').textContent = trans.activeOrders;
            document.getElementById('completedOrdersTitle').textContent = trans.completedOrders;
            document.getElementById('noActiveOrders').textContent = trans.noActiveOrders;
            document.getElementById('noCompletedOrders').textContent = trans.noCompletedOrders;
            document.getElementById('syncText').textContent = trans.syncText;
            
            // ì—…ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸
            if (!uploadedFile) {
                document.getElementById('uploadButtonText').innerHTML = `ğŸ“ ${trans.uploadText}`;
            }
            
            // í™˜ìœ¨ í…ìŠ¤íŠ¸
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
            
            if (exchangeRate > 0) {
                document.getElementById('exchangeRate').innerHTML = 
                    `<span style="color:#e53e3e;font-weight:bold;">${exchangeRate.toFixed(2)}</span>`;
                document.getElementById('rateUpdate').textContent = trans.lastUpdate + timeString;
            }
            
            // ëª¨ë‹¬ ì—´ë ¤ìˆìœ¼ë©´ ëª¨ë‹¬ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸
            if (!document.getElementById('qrModal').classList.contains('hidden')) {
                updateModalText();
            }
            
            // ì£¼ë¬¸ ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOrdersList();
        }

        // ==================== í™˜ìœ¨ ê´€ë ¨ í•¨ìˆ˜ ====================
        async function fetchRealTimeExchangeRate() {
            try {
                const apiEndpoints = [
                    'https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=thb',
                    'https://api.binance.com/api/v3/ticker/price?symbol=USDTTHB'
                ];
                
                let rate = 0;
                let success = false;
                
                for (const apiUrl of apiEndpoints) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (apiUrl.includes('coingecko')) {
                                if (data.tether && data.tether.thb) {
                                    rate = parseFloat(data.tether.thb);
                                }
                            } else if (apiUrl.includes('binance')) {
                                if (data.price) {
                                    rate = parseFloat(data.price);
                                }
                            }
                            
                            if (rate && rate > 0 && rate < 100) {
                                success = true;
                                break;
                            }
                        }
                    } catch (apiError) {
                        continue;
                    }
                }
                
                if (success) {
                    exchangeRate = rate;
                    updateExchangeRateDisplay(rate, true);
                } else {
                    exchangeRate = 35.5; // ê¸°ë³¸ í™˜ìœ¨
                    updateExchangeRateDisplay(35.5, false);
                }
                
            } catch (error) {
                console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', error);
                exchangeRate = 35.5;
                updateExchangeRateDisplay(35.5, false);
            }
        }

        function updateExchangeRateDisplay(rate, success) {
            const trans = translations[currentLang];
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
            
            const rateElement = document.getElementById('exchangeRate');
            
            if (success) {
                rateElement.innerHTML = `<span style="color:#e53e3e;font-weight:bold;">${rate.toFixed(2)}</span>`;
                document.getElementById('calcRate').textContent = rate.toFixed(2);
                document.getElementById('rateUpdate').textContent = trans.lastUpdate + timeString;
            } else {
                rateElement.innerHTML = `<span style="color:#e53e3e;font-weight:bold;">${rate.toFixed(2)}</span> (ê¸°ë³¸ê°’)`;
                document.getElementById('calcRate').textContent = rate.toFixed(2);
                document.getElementById('rateUpdate').textContent = trans.lastUpdate + 'ê¸°ë³¸ í™˜ìœ¨ ì ìš©';
            }
            
            updateCalculation();
        }

        // ==================== ê³„ì‚° ë° ê²°ì œ ê´€ë ¨ í•¨ìˆ˜ ====================
        function updateCalculation() {
            const amount = parseInt(document.getElementById('thbAmount').value) || 0;
            const calcPreview = document.getElementById('calcPreview');
            
            const minAmount = 1000;
            const maxAmount = 500000;
            
            if (amount < minAmount || amount > maxAmount) {
                calcPreview.style.display = 'none';
                document.getElementById('payButton').disabled = true;
                return;
            }
            
            if (amount > 0 && exchangeRate > 0) {
                calcPreview.style.display = 'block';
                
                const usdtAmount = amount / exchangeRate;
                const fee = usdtAmount * 0.03;
                const total = usdtAmount + fee;
                
                document.getElementById('calcAmount').textContent = amount.toLocaleString() + ' THB';
                document.getElementById('calcUsdt').textContent = usdtAmount.toFixed(4) + ' USDT';
                document.getElementById('calcFee').textContent = fee.toFixed(4) + ' USDT';
                document.getElementById('calcTotal').textContent = total.toFixed(4) + ' USDT';
                
                checkPaymentButton();
            } else {
                calcPreview.style.display = 'none';
                document.getElementById('payButton').disabled = true;
            }
        }

        function checkPaymentButton() {
            const amount = parseInt(document.getElementById('thbAmount').value) || 0;
            const payButton = document.getElementById('payButton');
            
            if (amount >= 1000 && amount <= 500000 && uploadedFile !== null && exchangeRate > 0) {
                payButton.disabled = false;
            } else {
                payButton.disabled = true;
            }
        }

        // ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ====================
        function setupEventListeners() {
            document.getElementById('thbAmount').addEventListener('input', updateCalculation);
            
            const fileInput = document.getElementById('paymentProof');
            const uploadButton = document.querySelector('.upload-button');
            
            uploadButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    handleFileUpload(this.files[0]);
                } else {
                    uploadedFile = null;
                    checkPaymentButton();
                }
            });
            
            document.getElementById('payButton').addEventListener('click', startPayment);
            
            document.getElementById('closeModal').addEventListener('click', function() {
                if (confirm(currentLang === 'en' ? 
                    'Cancel payment?\n\nCurrent payment will be cancelled.' : 
                    'ê²°ì œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ê²°ì œê°€ ì·¨ì†Œë©ë‹ˆë‹¤.')) {
                    cancelPayment();
                }
            });
            
            document.getElementById('copyAddress').addEventListener('click', copyWalletAddress);
            
            document.getElementById('finishPayment').addEventListener('click', finishPayment);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            uploadButton.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
            });
            
            uploadButton.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#cbd5e0';
            });
            
            uploadButton.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#cbd5e0';
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                    fileInput.files = e.dataTransfer.files;
                }
            });
        }

        // ==================== íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ ====================
        function handleFileUpload(file) {
            if (!file) {
                uploadedFile = null;
                checkPaymentButton();
                return;
            }
            
            uploadedFile = file;
            
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                alert(currentLang === 'en' ? 
                    'File size must be less than 5MB' : 
                    'íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                uploadedFile = null;
                checkPaymentButton();
                return;
            }
            
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert(currentLang === 'en' ? 
                    'Only images (JPEG, PNG, GIF) are allowed for QR code screenshot' : 
                    'QR ì½”ë“œ ìŠ¤í¬ë¦°ìƒ·ì€ ì´ë¯¸ì§€(JPEG, PNG, GIF) íŒŒì¼ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.');
                uploadedFile = null;
                checkPaymentButton();
                return;
            }
            
            const uploadText = currentLang === 'en' ? 'Upload completed' : 'ì—…ë¡œë“œ ì™„ë£Œ';
            document.getElementById('uploadButtonText').innerHTML = 
                `âœ… ${uploadText}<br><span style="font-size:12px;color:#718096;">${file.name}</span>`;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('uploadPreview').innerHTML = `
                        <img src="${e.target.result}" alt="Payment proof" class="upload-preview-image">
                        <div class="file-info">
                            ${file.name} (${(file.size / 1024).toFixed(1)}KB)
                        </div>
                    `;
                    checkPaymentButton();
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('uploadPreview').innerHTML = `
                    <div style="font-size: 40px; margin: 10px 0;">ğŸ“„</div>
                    <div class="file-info">
                        ${file.name}<br>
                        (${(file.size / 1024).toFixed(1)}KB)
                    </div>
                `;
                checkPaymentButton();
            }
        }

        // ==================== ê²°ì œ ì‹œì‘ ====================
        function startPayment() {
            const amount = parseInt(document.getElementById('thbAmount').value);
            const trans = translations[currentLang];
            
            if (!amount || amount < 1000) {
                alert(trans.amountMinAlert);
                return;
            }
            
            if (amount > 500000) {
                alert(trans.amountMaxAlert);
                return;
            }
            
            if (!uploadedFile) {
                alert(trans.uploadRequiredAlert);
                return;
            }

            if (exchangeRate <= 0) {
                alert(currentLang === 'en' ? 
                    'Exchange rate is not loaded yet. Please wait.' : 
                    'í™˜ìœ¨ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                return;
            }

            // ìƒˆ ì£¼ë¬¸ ID ìƒì„±
            currentOrderId = dataManager.generateOrderId();
            document.getElementById('orderId').textContent = currentOrderId;
            
            const usdtAmount = amount / exchangeRate;
            const fee = usdtAmount * 0.03;
            const total = usdtAmount + fee;
            
            document.getElementById('modalTotal').textContent = total.toFixed(4) + ' USDT';
            
            // íŒŒì¼ì„ base64ë¡œ ë³€í™˜
            const reader = new FileReader();
            reader.onload = function(e) {
                const proofData = {
                    name: uploadedFile.name,
                    type: uploadedFile.type,
                    size: uploadedFile.size,
                    data: e.target.result
                };
                
                // ìƒˆ ì£¼ë¬¸ ìƒì„±
                const order = {
                    id: currentOrderId,
                    amount: amount,
                    usdt: total,
                    status: 'ì…ê¸ˆëŒ€ê¸°',
                    step: 1,
                    time: new Date().toISOString(),
                    wallet: activeWallet ? {
                        id: activeWallet.id,
                        name: activeWallet.name,
                        address: activeWallet.address,
                        network: activeWallet.network
                    } : null,
                    proof: proofData
                };
                
                // ì£¼ë¬¸ ì €ì¥
                saveOrder(order);
                
                // UI ì—…ë°ì´íŠ¸
                updateOrdersList();
                
                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('qrModal').classList.remove('hidden');
                updateModalText();
                
                // íƒ€ì´ë¨¸ ì‹œì‘
                startTimer();
                
                // ìƒíƒœ ì²´í¬ ì‹œì‘
                startStatusChecking();
            };
            
            reader.onerror = function(e) {
                alert(currentLang === 'en' ? 
                    'File reading error. Please try again.' : 
                    'íŒŒì¼ ì½ê¸° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            };
            
            reader.readAsDataURL(uploadedFile);
        }

        // ==================== ì£¼ë¬¸ ì €ì¥ ====================
        function saveOrder(order) {
            // ê¸°ì¡´ ì£¼ë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            let orders = dataManager.getOrders();
            
            // ì¤‘ë³µ ì£¼ë¬¸ ì²´í¬
            const existingIndex = orders.findIndex(o => o.id === order.id);
            
            if (existingIndex > -1) {
                orders[existingIndex] = order;
            } else {
                orders.unshift(order);
            }
            
            // ìµœëŒ€ 50ê°œë§Œ ìœ ì§€
            if (orders.length > 50) {
                orders = orders.slice(0, 50);
            }
            
            // ì €ì¥
            dataManager.saveOrders(orders);
            
            // ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            allOrders = orders;
            
            console.log('ì£¼ë¬¸ ì €ì¥ë¨:', order.id);
        }

        // ==================== ì£¼ë¬¸ ëª©ë¡ ì—…ë°ì´íŠ¸ ====================
        function updateOrdersList() {
            const trans = translations[currentLang];
            
            // í™œì„± ì£¼ë¬¸ê³¼ ì™„ë£Œëœ ì£¼ë¬¸ ë¶„ë¦¬
            const activeOrders = allOrders.filter(order => 
                order.status === 'ì…ê¸ˆëŒ€ê¸°' || 
                order.status === 'ì…ê¸ˆí™•ì¸' || 
                order.status === 'ì²˜ë¦¬ì¤‘'
            );
            
            const completedOrders = allOrders.filter(order => 
                order.status === 'ì™„ë£Œ' || 
                order.status === 'ì·¨ì†Œ'
            );
            
            const activeOrdersList = document.getElementById('activeOrdersList');
            const completedOrdersList = document.getElementById('completedOrdersList');
            
            // í™œì„± ì£¼ë¬¸ í‘œì‹œ
            if (activeOrders.length === 0) {
                activeOrdersList.innerHTML = `
                    <div class="no-orders">
                        ${trans.noActiveOrders}
                    </div>
                `;
            } else {
                let html = '';
                activeOrders.forEach(order => {
                    html += createOrderCard(order);
                });
                activeOrdersList.innerHTML = html;
            }
            
            // ì™„ë£Œëœ ì£¼ë¬¸ í‘œì‹œ
            if (completedOrders.length === 0) {
                completedOrdersList.innerHTML = `
                    <div class="no-orders">
                        ${trans.noCompletedOrders}
                    </div>
                `;
            } else {
                let html = '';
                completedOrders.forEach(order => {
                    html += createOrderCard(order);
                });
                completedOrdersList.innerHTML = html;
            }
        }

        function createOrderCard(order) {
            const trans = translations[currentLang];
            
            const statusClass = {
                'ì…ê¸ˆëŒ€ê¸°': 'status-waiting',
                'ì…ê¸ˆí™•ì¸': 'status-confirmed',
                'ì²˜ë¦¬ì¤‘': 'status-processing',
                'ì™„ë£Œ': 'status-completed',
                'ì·¨ì†Œ': 'status-cancelled'
            }[order.status] || 'status-waiting';
            
            const statusText = {
                'ì…ê¸ˆëŒ€ê¸°': trans.waitingDeposit,
                'ì…ê¸ˆí™•ì¸': trans.depositConfirmed,
                'ì²˜ë¦¬ì¤‘': trans.processing,
                'ì™„ë£Œ': trans.completed,
                'ì·¨ì†Œ': trans.cancelled
            }[order.status] || order.status;
            
            const time = new Date(order.time).toLocaleTimeString();
            
            let proofHtml = '';
            if (order.proof && order.proof.data) {
                const proofLabel = currentLang === 'en' ? 'Proof:' : 'ì¦ëª…ì„œ:';
                const attachedText = currentLang === 'en' ? 'Attached' : 'ì²¨ë¶€ë¨';
                
                if (order.proof.type && order.proof.type.startsWith('image/')) {
                    proofHtml = `
                        <div class="breakdown-item">
                            <span>${proofLabel}</span>
                            <span>${attachedText}</span>
                        </div>
                        <img src="${order.proof.data}" alt="Payment proof" class="proof-image">
                    `;
                } else {
                    proofHtml = `
                        <div class="breakdown-item">
                            <span>${proofLabel}</span>
                            <span>${order.proof.name}</span>
                        </div>
                    `;
                }
            }
            
            const usdtLabel = currentLang === 'en' ? 'USDT Amount:' : 'USDT ê¸ˆì•¡:';
            const stepLabel = currentLang === 'en' ? 'Current Step:' : 'í˜„ì¬ ë‹¨ê³„:';
            const walletLabel = currentLang === 'en' ? 'Deposit Wallet:' : 'ì…ê¸ˆ ì§€ê°‘:';
            
            return `
                <div class="order-card ${statusClass}">
                    <div class="order-header">
                        <div>
                            <div class="order-id">${order.id}</div>
                            <div class="order-time">${time}</div>
                        </div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-amount">${order.amount.toLocaleString()} THB</div>
                        <div class="order-breakdown">
                            <div class="breakdown-item">
                                <span>${usdtLabel}</span>
                                <span>${order.usdt.toFixed(4)} USDT</span>
                            </div>
                            <div class="breakdown-item">
                                <span>${stepLabel}</span>
                                <span>${statusText}</span>
                            </div>
                            ${order.wallet ? `
                            <div class="breakdown-item">
                                <span>${walletLabel}</span>
                                <span>${order.wallet.name}</span>
                            </div>
                            ` : ''}
                            ${proofHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ====================
        function updateModalText() {
            const trans = translations[currentLang];
            
            document.getElementById('modalTitle').textContent = trans.modalTitle;
            document.getElementById('walletSelectionTitle').textContent = trans.walletSelectionTitle;
            document.getElementById('step1Description').textContent = trans.step1Description;
            document.getElementById('copyButtonText').textContent = trans.copyButtonText;
            document.getElementById('modalTotalLabel').textContent = trans.modalTotalLabel;
            document.getElementById('orderIdLabel').textContent = trans.orderIdLabel;
            document.getElementById('statusMessage1Text').textContent = trans.statusMessage1Text;
            document.getElementById('step2Description').textContent = trans.step2Description;
            document.getElementById('statusMessage2Text').textContent = trans.statusMessage2Text;
            document.getElementById('step3Description').textContent = trans.step3Description;
            document.getElementById('statusMessage3Text').textContent = trans.statusMessage3Text;
            document.getElementById('completeMessage').textContent = trans.completeMessage;
            document.getElementById('step4Description').textContent = trans.step4Description;
            document.getElementById('finishButtonText').textContent = trans.finishButtonText;
            document.getElementById('timerLabel').textContent = trans.timerLabel;
            document.getElementById('autoUpdateText').textContent = trans.autoUpdateText;
        }

        function updateWalletDisplay() {
            if (!activeWallet) return;
            
            document.getElementById('walletAddress').textContent = activeWallet.address;
            const networkClass = `network-${activeWallet.network.toLowerCase()}`;
            
            let networkText = '';
            switch(activeWallet.network) {
                case 'TRC20': networkText = 'TRC20 Network'; break;
                case 'ERC20': networkText = 'ERC20 Network'; break;
                case 'BEP20': networkText = 'BEP20 Network'; break;
                default: networkText = activeWallet.network + ' Network';
            }
            
            document.getElementById('selectedWalletInfo').innerHTML = `
                <div class="wallet-icon">ğŸ‘›</div>
                <div class="wallet-details">
                    <div class="wallet-name">${activeWallet.name}</div>
                    <div class="wallet-network">
                        ${networkText}
                        <span class="network-badge ${networkClass}">${activeWallet.network}</span>
                    </div>
                </div>
            `;
        }

        function copyWalletAddress() {
            const address = document.getElementById('walletAddress').textContent;
            navigator.clipboard.writeText(address)
                .then(() => {
                    const copiedText = currentLang === 'en' ? 'Copied' : 'ë³µì‚¬ë¨';
                    document.getElementById('copyButtonText').textContent = copiedText;
                    setTimeout(() => {
                        const trans = translations[currentLang];
                        document.getElementById('copyButtonText').textContent = trans.copyButtonText;
                    }, 2000);
                });
        }

        // ==================== íƒ€ì´ë¨¸ ====================
        function startTimer() {
            timeLeft = 300;
            updateTimerDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert(currentLang === 'en' ? 
                        'Payment time expired' : 
                        'ê²°ì œ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                    cancelPayment();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timeLeft').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==================== ê²°ì œ ì·¨ì†Œ/ì™„ë£Œ ====================
        function cancelPayment() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (currentOrderId) {
                updateOrderStatus('ì·¨ì†Œ', 1);
            }
            
            document.getElementById('qrModal').classList.add('hidden');
            resetSteps();
            
            alert(currentLang === 'en' ? 'Payment cancelled' : 'ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        function finishPayment() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('qrModal').classList.add('hidden');
            resetSteps();
            
            alert(currentLang === 'en' ? 'Payment completed!' : 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('thbAmount').value = '';
            document.getElementById('paymentProof').value = '';
            const trans = translations[currentLang];
            document.getElementById('uploadButtonText').innerHTML = `ğŸ“ ${trans.uploadText}`;
            document.getElementById('uploadPreview').innerHTML = '';
            uploadedFile = null;
            updateCalculation();
        }

        function resetSteps() {
            currentStep = 1;
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active', 'completed');
            document.getElementById('step3').classList.remove('active', 'completed');
            document.getElementById('step4').classList.remove('active', 'completed');
            
            document.getElementById('step1Content').style.display = 'block';
            document.getElementById('step2Content').style.display = 'none';
            document.getElementById('step3Content').style.display = 'none';
            document.getElementById('step4Content').style.display = 'none';
        }

        // ==================== ìƒíƒœ ì²´í¬ ë° ì—…ë°ì´íŠ¸ ====================
        function startStatusChecking() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            
            statusCheckInterval = setInterval(() => {
                checkOrderStatus();
            }, 3000);
        }

        function checkOrderStatus() {
            // í˜„ì¬ ì£¼ë¬¸ ì°¾ê¸°
            const currentOrder = allOrders.find(order => order.id === currentOrderId);
            
            if (!currentOrder) return;
            
            // ìƒíƒœì— ë”°ë¥¸ ë‹¨ê³„ ì´ë™
            switch(currentOrder.status) {
                case 'ì…ê¸ˆí™•ì¸':
                    if (currentStep < 2) goToStep(2);
                    break;
                case 'ì²˜ë¦¬ì¤‘':
                    if (currentStep < 3) goToStep(3);
                    break;
                case 'ì™„ë£Œ':
                    if (currentStep < 4) {
                        goToStep(4);
                        clearInterval(statusCheckInterval);
                    }
                    break;
                case 'ì·¨ì†Œ':
                    cancelPayment();
                    clearInterval(statusCheckInterval);
                    break;
            }
        }

        function goToStep(step) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');
            document.getElementById(`step${currentStep}Content`).style.display = 'none';
            
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}Content`).style.display = 'block';
            
            let status = '';
            switch(step) {
                case 1: status = 'ì…ê¸ˆëŒ€ê¸°'; break;
                case 2: status = 'ì…ê¸ˆí™•ì¸'; break;
                case 3: status = 'ì²˜ë¦¬ì¤‘'; break;
                case 4: status = 'ì™„ë£Œ'; break;
            }
            
            if (status) {
                updateOrderStatus(status, step);
            }
        }

        function updateOrderStatus(status, step = currentStep) {
            // í˜„ì¬ ì£¼ë¬¸ ì°¾ê¸°
            const orderIndex = allOrders.findIndex(o => o.id === currentOrderId);
            if (orderIndex === -1) return;
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            allOrders[orderIndex] = {
                ...allOrders[orderIndex],
                status: status,
                step: step,
                updated: new Date().toISOString()
            };
            
            // ì €ì¥
            dataManager.saveOrders(allOrders);
            
            // UI ì—…ë°ì´íŠ¸
            updateOrdersList();
        }

        // ==================== ë°ì´í„° ë™ê¸°í™” ====================
        function startSyncCheck() {
            if (syncCheckInterval) clearInterval(syncCheckInterval);
            
            syncCheckInterval = setInterval(() => {
                checkDataSync();
            }, 2000);
        }

        function checkDataSync() {
            if (dataManager.needsSync()) {
                showSyncStatus();
                
                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                const updatedOrders = dataManager.getOrders();
                const updatedWallets = dataManager.getWallets();
                
                // ì£¼ë¬¸ ë°ì´í„° ë¹„êµ
                if (JSON.stringify(updatedOrders) !== JSON.stringify(allOrders)) {
                    console.log('ì£¼ë¬¸ ë°ì´í„° ì—…ë°ì´íŠ¸ë¨');
                    allOrders = updatedOrders;
                    updateOrdersList();
                    
                    // í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ í™•ì¸
                    if (currentOrderId) {
                        const currentOrder = allOrders.find(o => o.id === currentOrderId);
                        if (currentOrder && currentOrder.status) {
                            const status = currentOrder.status;
                            const step = currentOrder.step || 1;
                            
                            if (currentStep !== step) {
                                goToStep(step);
                            }
                        }
                    }
                }
                
                // ì§€ê°‘ ë°ì´í„° ë¹„êµ
                if (JSON.stringify(updatedWallets) !== JSON.stringify(allWallets)) {
                    console.log('ì§€ê°‘ ë°ì´í„° ì—…ë°ì´íŠ¸ë¨');
                    allWallets = updatedWallets;
                    activeWallet = dataManager.getActiveWallet();
                    updateWalletDisplay();
                }
                
                // ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
                dataManager.updateUserSync();
                
                // 2ì´ˆ í›„ì— ë™ê¸°í™” ìƒíƒœ ìˆ¨ê¸°ê¸°
                setTimeout(hideSyncStatus, 2000);
            }
        }

        function showSyncStatus() {
            const syncElement = document.getElementById('syncStatus');
            syncElement.classList.add('visible');
        }

        function hideSyncStatus() {
            const syncElement = document.getElementById('syncStatus');
            syncElement.classList.remove('visible');
        }

        // ==================== ê´€ë¦¬ì í˜ì´ì§€ í†µì‹  í•¨ìˆ˜ ====================
        // ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜
        window.updateOrderStatusFromAdmin = function(orderId, newStatus) {
            console.log('ê´€ë¦¬ìë¡œë¶€í„° ìƒíƒœ ì—…ë°ì´íŠ¸:', orderId, newStatus);
            
            const orderIndex = allOrders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            const step = getStepFromStatus(newStatus);
            allOrders[orderIndex] = {
                ...allOrders[orderIndex],
                status: newStatus,
                step: step,
                updated: new Date().toISOString()
            };
            
            dataManager.saveOrders(allOrders);
            
            // í˜„ì¬ ì£¼ë¬¸ì´ë©´ UI ì—…ë°ì´íŠ¸
            if (currentOrderId === orderId && currentStep !== step) {
                goToStep(step);
            }
            
            updateOrdersList();
        };

        window.updateWalletsFromAdmin = function(wallets) {
            console.log('ê´€ë¦¬ìë¡œë¶€í„° ì§€ê°‘ ì—…ë°ì´íŠ¸:', wallets.length, 'ê°œ');
            allWallets = wallets;
            localStorage.setItem('payment_wallets', JSON.stringify(wallets));
            activeWallet = dataManager.getActiveWallet();
            updateWalletDisplay();
        };

        function getStepFromStatus(status) {
            switch(status) {
                case 'ì…ê¸ˆëŒ€ê¸°': return 1;
                case 'ì…ê¸ˆí™•ì¸': return 2;
                case 'ì²˜ë¦¬ì¤‘': return 3;
                case 'ì™„ë£Œ': return 4;
                case 'ì·¨ì†Œ': return 1;
                default: return 1;
            }
        }

        // ==================== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ====================
        window.createTestOrder = function() {
            const testOrder = {
                id: dataManager.generateOrderId(),
                amount: Math.floor(Math.random() * 10000) + 1000,
                usdt: Math.random() * 100 + 10,
                status: 'ì…ê¸ˆëŒ€ê¸°',
                step: 1,
                time: new Date().toISOString(),
                wallet: activeWallet ? {
                    id: activeWallet.id,
                    name: activeWallet.name,
                    address: activeWallet.address,
                    network: activeWallet.network
                } : null,
                proof: {
                    name: 'test.png',
                    type: 'image/png',
                    size: 1024,
                    data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }
            };
            
            saveOrder(testOrder);
            updateOrdersList();
            
            alert(`í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ${testOrder.id} ìƒì„±ë¨`);
        };
    </script>
</body>
</html>
